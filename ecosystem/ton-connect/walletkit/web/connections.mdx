---
title: "How to handle connections with WalletKit on the Web platform"
sidebarTitle: "Handle connections"
---

import { Aside } from '/snippets/aside.jsx';

<Aside>
  [Initialize the WalletKit](./init) and [set up at least one TON wallet](./wallets) before using examples on this page.
</Aside>

For dApps to use a wallet service for sending transactions and signing data via its TON wallets, they first need to set up a connection. The wallet services then need to handle connection request and disconnection events.

## Connection flow

1. User scans QR code or clicks a "Connect wallet" or a similar button
1. WalletKit processes the URL and triggers the `onConnectRequest` event
1. Then, the dApp shows a connection request waiting for the user's approval
1. User approves or rejects the connection

If the connection was approved, the dApp could proceed to send various transaction or data sign requests.

## Handlers

The WalletKit expects three kinds of callbacks to handle connections:

- Within the `onConnectRequest()` method: to process new connect requests and re-connections
- Within the `onDisconnect()` method: to register dApp disconnects
- And within the `onRequestError()` method: to [handle errors](./events#handle-request-errors) arising in any of the requests

### Handle `onConnectRequest`

When a user wants to connect a wallet service from the dApp, the dApp fires the `connect` request over the bridge. The wallet service then handles it with the `onConnectRequest` method of the WalletKit.

On the dApp side, this flow is often initiated by pressing the "Connect a wallet" button, followed by selecting the user's wallet service. Additionally, a dApp can produce a [QR code or a deep link](#qr-codes-and-deep-links), which can also initiate the connection flow from within the wallet service.

```ts title="TypeScript"
kit.onConnectRequest(async (event) => {
  try {
    const wallets = kit.getWallets();
    if (wallets.length === 0) {
      // Make sure to present a message to the user.
      console.log('No wallets available');
      await kit.rejectConnectRequest(event, 'No wallets available');
      return;
    }
    const dappName = event.preview.manifest?.name || 'Unknown dApp';
    const dappUrl = event.preview.manifest?.url || 'Unknown URL';
    // Show the connection confirmation UI to the user of the wallet service
    if (confirm(`Connect to ${dappName} from ${dappUrl}?`)) {
      // Set wallet address on the request before approving
      event.walletAddress = wallets[0].getAddress();
      await kit.approveConnectRequest(event);
      console.log('Connected to:', dappName);
    } else {
      await kit.rejectConnectRequest(event, 'User rejected');
      console.log('Connection rejected by a user');
    }
  } catch (error) {
    console.error('Connection handler error:', error);
    await kit.rejectConnectRequest(event, 'Fatal error in the connection handler');
  }
});
```

<Aside>
  DApps can also initiate the `restoreConnection` events through the bridge, and they would be processed next to `connect` requests in the same `onConnectRequest` method of the WalletKit.
</Aside>

#### Wallet selection

When there are several TON wallets added, ask the user to select one before approving the connection request.

```ts title="TypeScript"
kit.onConnectRequest(async (event) => {
  try {
    const wallets = kit.getWallets();
    if (wallets.length === 0) {
      // Make sure to present a message to the user.
      console.log('No wallets available');
      await kit.rejectConnectRequest(event, 'No wallets available');
      return;
    }
    // Selecting the 1st TON wallet by default
    let selectedWallet = { ok: true, wallet: wallets[0] };
    // Yet, asking the user to pick one if there are many
    if (wallets.length > 1) {
      // Here, uiSelectWallet() is assumed to be implemented elsewhere:
      // it takes the list of wallets and provides the user with a choice
      // to pick one from the list, then returns with the picked option
      // or a rejection if there was none.
      selectedWallet = await uiSelectWallet(wallets);
    }
    if (!selectedWallet.ok) {
      // Make sure to present a message to the user.
      console.log('No wallet selected');
      await kit.rejectConnectRequest(event, 'No wallet selected');
      return;
    }
    const dappName = event.preview.manifest?.name || 'Unknown dApp';
    const dappUrl = event.preview.manifest?.url || 'Unknown URL';
    // Show the connection confirmation UI to the user of the wallet service
    if (confirm(`Connect to ${dappName} from ${dappUrl}?`)) {
      // Set wallet address on the request before approving
      event.walletAddress = selectedWallet.wallet.getAddress();
      await kit.approveConnectRequest(event);
      console.log('Connected to:', dappName);
    } else {
      await kit.rejectConnectRequest(event, 'User rejected');
      console.log('Connection rejected by a user');
    }
  } catch (error) {
    console.error('Connection handler error:', error);
    await kit.rejectConnectRequest(event, 'Fatal error in the connection handler');
  }
});
```

#### QR codes and deep links

The `handleTonConnectUrl()` method of the WalletKit parses a TON Connect link and creates a new connection request event.

Usually, this link comes from a QR code formed on the dApp side, but it can also be provided within the mobile dApp in form of a deep link.

```ts title="TypeScript"
async function handleQrCode(content: string) {
  try {
    // On success, this will fire the onConnectRequest handler:
    await kit.handleTonConnectUrl(content);
  } catch (error) {
    console.error('Invalid QR code:', error);
    // Make sure to present an error to the user.
    throw new Error('Failed to process TON Connect QR code');
  }
}

async function handleDeepLink(url: string) {
  if (url.startsWith('tc://') || url.includes('ton-connect')) {
    try {
      // On success, this will fire the onConnectRequest handler:
      await walletKit.handleTonConnectUrl(url);
    } catch (error) {
      console.error('Invalid link:', error);
      // Make sure to present an error to the user.
      throw new Error('Failed to process TON Connect deep link');
    }
  }
}
```

### Handle `onDisconnect`

When a user disconnects a wallet service from the dApp, the dApp fires the `disconnect` request over the bridge. The wallet service then handles it with the `onDisconnect` method of the WalletKit.

```ts title="TypeScript"
kit.onDisconnect(async (event) => {
  // Clean up any UI state related to this connection.
  console.log(`Disconnected from a dApp that used this TON wallet: ${event.walletAddress}`);
});
```

## Next steps

<Columns cols={2}>
  <Card
    title="Handle other events"
    icon="signature"
    horizontal="true"
    href="/ecosystem/ton-connect/walletkit/web/events"
  />
</Columns>

## See also

- [WalletKit overview](/ecosystem/ton-connect/walletkit)
- [TON Connect overview](/ecosystem/ton-connect)
