---
title: "Reserve coins"
---

_Reserving coins_ is one of actions that a smart contract can perform during the [action phase](/foundations/phases#action-phase).
The corresponding instruction `reserveToncoinsOnBalance` in Tolk takes two parameters:

- an `amount` of nanotoncoin to reserve;
- a `mode` that specifies how the reservation will be performed.

The `mode` parameter is a bitmask that specifies how the reservation amount is calculated. The resulting mode value can have the following base modes:

| Mode value | Convenient name    | Description                                             |
| ---------: | :----------------- | ------------------------------------------------------- |
|        $0$ | `ReserveExact`     | Reserves exactly the specified `amount` of nanotoncoin. |
|        $1$ | `ReserveAllExcept` | Reserves all but the specified `amount` of nanotoncoin. |
|        $2$ | `ReserveAtMost`    | Reserves at most the specified `amount` of nanotoncoin. |

Additionally, the resulting `mode` can have the following optional flags added:

| Flag value | Convenient name             | Description                                                                                                                           |
| ---------: | :-------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |
|       $+4$ | `ReserveAddOriginalBalance` | Increases the `amount` by the original balance (i.e. without incoming message value) of the current account before the compute phase. |
|       $+8$ | `ReserveInvertSign`         | Negates the `amount` value before performing the reservation.                                                                         |
|      $+16$ | `ReserveBounceIfActionFail` | Bounces the transaction if the reservation fails.                                                                                     |

Roughly speaking, the instruction is equivalent to creating an outbound message carrying the specified `amount` of nanotoncoin to oneself.
Its primary goal is to reduce the amount of toncoins that can be spent by subsequent actions. For the detailed description of the reservation behavior, see [reserve implementation](/foundations/messages/reserve#implementation).

## Best practices

### Ensuring that a smart contract will have enough balance to pay for its storage fees in the future.

After the transaction, it is often important to ensure that the remaining account balance is sufficient to cover storage fees for an
extended period of time. Good examples of this scenario can be found in the [Jetton wallet contracts](https://github.com/ton-blockchain/jetton-contract/blob/d55f228edb0eb477cb4845d67e0dacc6489c6b57/contracts/jetton-wallet.fc#L124) and the [Jetton master contracts](https://github.com/ton-blockchain/jetton-contract/blob/d55f228edb0eb477cb4845d67e0dacc6489c6b57/contracts/jetton-minter.fc#L38).

It is possible to estimate the number of nanotons that an account needs for a year of downtime and then reserve in the first action of the action phase.

```tolk
reserveToncoinsOnBalance(<estimated_amount_for_a_year>, 0); ;; for reserving exact amount
;; or
reserveToncoinsOnBalance(<estimated_amount_for_a_year>, RESERVE_MODE_AT_MOST); ;; for reserving at most the amount
```

### Ensuring that all fees are paid from the incoming message value

If contract's logic implies that a user should be responsible for all fees, then it would be advisable to reserve account's initial balance
at the start of action phase. This way, all fees will be deducted from the incoming message value (if there are enough funds), and the account's balance will remain unchanged after the transaction.

The good practice is to use the `ReserveAddOriginalBalance` flag. But since this flag adds only the account original balance before the compute phase,
we need to account for the storage fees that were already deducted. As in the previous example, it is possible to add some approximate value.

```tolk
reserveToncoinsOnBalance(<estimated_storage_fee>, RESERVE_MODE_INCREASE_BY_ORIGINAL_BALANCE);
```

### Setting a limit on the next actions spending

Sometimes it is useful to limit the amount of toncoins that subsequent actions can spend. To do this, it is enough to reserve the entire remaining balance at the moment,
with the exception of a certain amount of it.

```tolk
reserveToncoinsOnBalance(<limit>, RESERVE_MODE_NEGATE_AMOUNT); ;; ReserveAllExcept
```

### Sending whole contract balance except some value

The reservation of funds can be combined with the subsequent sending of a message, the value of which will be the remaining balance after the reservation.

```tolk
reserveToncoinsOnBalance(<some_value>, 0);
val msg = createMessage({
        ...
    });
    
msg.send(SEND_MODE_CARRY_ALL_BALANCE);
```
